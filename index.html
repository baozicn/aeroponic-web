<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>雾境智培 - 智能栽培控制台</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MQTT -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #0d253f;
      --card-bg: #112e51;
      --accent: #2a6f97;
      --highlight: #4fc3f7;
      --danger: #e76f51;
      --text: #f1f1f1;
      --muted: #88a3b0;
      --radius: 12px;
      --pad: 16px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: 'Inter', 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); line-height:1.5; }
    a { color: var(--highlight); text-decoration:none; }
    header { padding: var(--pad); display:flex; align-items:center; justify-content:space-between; background: linear-gradient(90deg, #00172d, #00345b); box-shadow:0 2px 4px rgba(0,0,0,0.4); }
    .logo { font-size:22px; font-weight:600; }
    .nav { display:flex; gap:24px; }
    .nav-item { cursor:pointer; padding:8px 12px; border-radius:var(--radius); color: var(--muted); }
    .nav-item.active { background: var(--highlight); color: #0d253f; font-weight:500; }
    .container { max-width:1100px; margin:auto; padding: var(--pad); }
    .hero { text-align:center; margin:40px 0; }
    .hero-title { font-size:32px; font-weight:600; margin-bottom:8px; }
    .hero-sub { color: var(--muted); font-size:16px; }
    .btn { display:inline-block; padding:10px 18px; border-radius:var(--radius); border:1px solid var(--accent); background: var(--accent); color:#fff; cursor:pointer; margin-right:10px; margin-top:8px; }
    .btn.secondary { background:none; border-color: var(--highlight); color: var(--highlight); }
    .btn.danger { background: var(--danger); border-color: var(--danger); }
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: var(--pad); margin-bottom: var(--pad); }
    .card { background: var(--card-bg); border-radius:var(--radius); padding: var(--pad); box-shadow:0 2px 4px rgba(0,0,0,0.4); }
    .metric-title { font-size:12px; color: var(--muted); }
    .metric-value { font-size:28px; margin-top:4px; }
    #trendChart { width:100%; max-height:300px; }
    .status-bar { margin-top:16px; font-size:12px; color: var(--muted); }
    /* Modal */
    .modal-mask { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal { background: var(--card-bg); border-radius:var(--radius); width:90%; max-width:420px; padding:var(--pad); box-shadow:0 2px 6px rgba(0,0,0,0.5); }
    .modal h2 { margin-top:0; font-size:20px; }
    .modal label { display:block; margin:8px 0 4px; font-size:12px; color: var(--muted); }
    .modal input { width:100%; padding:8px; border-radius:var(--radius); border:1px solid #284b63; background:#00172d; color: var(--text); }
    .modal .actions { text-align:right; margin-top:var(--pad); }
    .modal .actions .btn { margin-left:8px; }
    /* Device list */
    .device-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:var(--pad); }
    .dev-card { background: var(--card-bg); border-radius:var(--radius); padding:var(--pad); box-shadow:0 2px 4px rgba(0,0,0,0.4); }
    .dev-card h4 { margin:0 0 4px; font-size:16px; }
    .dev-card .small { font-size:12px; color: var(--muted); }
    .dev-card .actions { margin-top:8px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="logo">雾境智培</div>
    <nav class="nav">
      <div class="nav-item active" id="nav-dashboard" onclick="showSection('dashboard')">总览</div>
      <div class="nav-item" id="nav-control" onclick="showSection('control')">智控</div>
      <div class="nav-item" id="nav-devices" onclick="showSection('devices')">设备</div>
      <div class="nav-item" id="nav-about" onclick="showSection('about')">关于</div>
    </nav>
  </header>
  <div class="container">
    <!-- Dashboard section -->
    <section id="section-dashboard" class="active">
      <div class="hero">
        <div class="hero-title">智慧气雾栽培</div>
        <div class="hero-sub">实时监控 &middot; 智能控制 &middot; 生态未来</div>
        <div>
          <button class="btn" onclick="connectModal()">开始演示</button>
          <button class="btn secondary" onclick="copyShareLink()">复制评委链接</button>
        </div>
      </div>
      <div class="cards">
        <div class="card">
          <div class="metric-title">温度 (℃)</div>
          <div class="metric-value" id="val-temp">--</div>
        </div>
        <div class="card">
          <div class="metric-title">湿度 (%)</div>
          <div class="metric-value" id="val-hum">--</div>
        </div>
        <div class="card">
          <div class="metric-title">风扇</div>
          <div class="metric-value" id="val-fan">--</div>
        </div>
        <div class="card">
          <div class="metric-title">加热器</div>
          <div class="metric-value" id="val-heater">--</div>
        </div>
      </div>
      <div class="card" style="margin-top:var(--pad);">
        <canvas id="trendChart"></canvas>
      </div>
      <div class="status-bar" id="status-bar">未连接</div>
    </section>
    <!-- Control section -->
    <section id="section-control" class="hidden">
      <h3>智控</h3>
      <p class="small">针对当前设备快速控制。</p>
      <div class="card">
        <button class="btn" onclick="sendControl('fan',true)">风扇 ON</button>
        <button class="btn secondary" onclick="sendControl('fan',false)">风扇 OFF</button>
        <button class="btn" onclick="sendControl('heater',true)">加热 ON</button>
        <button class="btn secondary" onclick="sendControl('heater',false)">加热 OFF</button>
        <button class="btn danger" onclick="sendEmergency()">急停</button>
      </div>
    </section>
    <!-- Devices section -->
    <section id="section-devices" class="hidden">
      <h3>设备管理</h3>
      <div id="device-grid" class="device-grid"></div>
      <button class="btn" onclick="openAddDevice()">添加设备</button>
    </section>
    <!-- About section -->
    <section id="section-about" class="hidden">
      <h3>关于</h3>
      <div class="card">
        <p>雾境智培项目基于气雾栽培技术，通过物联网实现对环境的实时监控与智能调控。本控制台使用 MQTT 协议与 ESP32、微信小程序等终端进行通信。</p>
        <p>默认接入 EMQX 公共 Broker，可在高级设置中切换服务器。</p>
        <p>数据上报示例：<code>{"type":"data","temp":26.0,"hum":60,"fan":false,"heater":true,"deviceId":"aero-1234"}</code></p>
        <p>控制下发示例：<code>{"type":"control","device":"fan","state":true,"deviceId":"aero-1234"}</code></p>
      </div>
    </section>
  </div>
  <!-- Settings Modal -->
  <div id="modal-mask" class="modal-mask">
    <div class="modal">
      <h2>配置连接</h2>
      <label>WebSocket URL</label>
      <input id="inp-ws" placeholder="wss://..." value="wss://broker.emqx.io:8084/mqtt">
      <label>订阅 Topic</label>
      <input id="inp-sub" placeholder="home/data" value="home/data">
      <label>发布 Topic</label>
      <input id="inp-pub" placeholder="home/control" value="home/control">
      <label>设备 ID（可选）</label>
      <input id="inp-dev" placeholder="例如 aero-xxxx">
      <div class="actions">
        <button class="btn secondary" onclick="closeModal()">取消</button>
        <button class="btn" onclick="saveAndConnect()">连接</button>
      </div>
    </div>
  </div>
  <!-- Device Add Modal -->
  <div id="modal-device-mask" class="modal-mask">
    <div class="modal">
      <h2>添加设备</h2>
      <label>别名</label>
      <input id="inp-alias" placeholder="我的设备">
      <label>设备ID</label>
      <input id="inp-deviceId" placeholder="aero-xxxx">
      <label>订阅 Topic</label>
      <input id="inp-subTopic" placeholder="home/data">
      <label>发布 Topic</label>
      <input id="inp-pubTopic" placeholder="home/control">
      <div class="actions">
        <button class="btn secondary" onclick="closeDeviceModal()">取消</button>
        <button class="btn" onclick="confirmAddDevice()">保存</button>
      </div>
    </div>
  </div>
  <script>
    // UI navigation
    function showSection(name){
      const sections=['dashboard','control','devices','about'];
      sections.forEach(s=>{
        document.getElementById('section-'+s).classList.toggle('hidden',s!==name);
        document.getElementById('nav-'+s).classList.toggle('active',s===name);
      });
    }
    // Modal controls
    function connectModal(){ document.getElementById('modal-mask').style.display='flex'; }
    function closeModal(){ document.getElementById('modal-mask').style.display='none'; }
    function openAddDevice(){ document.getElementById('modal-device-mask').style.display='flex'; }
    function closeDeviceModal(){ document.getElementById('modal-device-mask').style.display='none'; }
    // MQTT
    let client = null;
    let chart;
    let labels=[];
    let temps=[];
    let hums=[];
    const maxPoints = 50;
    function initChart(){
      const ctx=document.getElementById('trendChart').getContext('2d');
      chart = new Chart(ctx,{
        type:'line',
        data:{ labels: labels, datasets:[
          { label:'温度(℃)', data: temps, borderColor: varGet('--accent'), backgroundColor:'transparent', borderWidth:2, tension:0.3 },
          { label:'湿度(%)', data: hums, borderColor: varGet('--highlight'), backgroundColor:'transparent', borderWidth:2, tension:0.3 }
        ]},
        options:{ plugins:{ legend:{ labels:{ color:varGet('--text') } } }, scales:{ x:{ ticks:{ color:varGet('--muted') } }, y:{ ticks:{ color:varGet('--muted') }, beginAtZero:true } } }
      });
    }
    function varGet(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    window.addEventListener('DOMContentLoaded',()=>{
      initChart();
      loadDevices();
    });
    function saveAndConnect(){
      const ws=document.getElementById('inp-ws').value.trim();
      const sub=document.getElementById('inp-sub').value.trim();
      const pub=document.getElementById('inp-pub').value.trim();
      const did=document.getElementById('inp-dev').value.trim();
      closeModal();
      disconnect();
      try{ client = mqtt.connect(ws, { clientId:'web-'+Math.random().toString(16).slice(2) }); } catch(e){ setStatus('连接失败: '+e.message); return; }
      client.on('connect',()=>{ setStatus('已连接'); client.subscribe(sub,(err)=>{ if(err) setStatus('订阅失败'); else setStatus('已订阅'); }); });
      client.on('message',(topic,payload)=>{
        let msg; try{ msg=JSON.parse(payload.toString()); }catch(e){ return; }
        if(did && msg.deviceId && msg.deviceId!==did) return;
        if(typeof msg.temp!=='undefined') document.getElementById('val-temp').textContent=msg.temp;
        if(typeof msg.hum!=='undefined') document.getElementById('val-hum').textContent=msg.hum;
        if(typeof msg.fan!=='undefined') document.getElementById('val-fan').textContent=msg.fan?'ON':'OFF';
        if(typeof msg.heater!=='undefined') document.getElementById('val-heater').textContent=msg.heater?'ON':'OFF';
        const time=new Date().toLocaleTimeString();
        if(labels.length>=maxPoints){ labels.shift(); temps.shift(); hums.shift(); }
        labels.push(time);
        temps.push(msg.temp);
        hums.push(msg.hum);
        chart.update('none');
      });
      client.on('close',()=>setStatus('连接已关闭'));
      client.on('error',(e)=>setStatus('错误: '+e.message));
    }
    function disconnect(){ if(client){ try{ client.end(); }catch(e){} } setStatus('未连接'); }
    function setStatus(text){ document.getElementById('status-bar').textContent=text; }
    function sendControl(device,state){ if(!client || client.connected!==true){ alert('请先连接'); return; } const pub=document.getElementById('inp-pub').value.trim(); const did=document.getElementById('inp-dev').value.trim(); const msg={ type:'control', device:device, state:state }; if(did) msg.deviceId=did; client.publish(pub, JSON.stringify(msg)); setStatus('已发送控制指令'); }
    function sendEmergency(){ sendControl('fan',false); sendControl('heater',false); }
    // Share link
    function copyShareLink(){ const params=new URLSearchParams(); params.set('autoconnect','1'); params.set('hidecfg','1'); const did=document.getElementById('inp-dev').value.trim(); if(did) params.set('deviceId', did); const url=window.location.origin+window.location.pathname+'?'+params.toString()+'#kiosk'; navigator.clipboard.writeText(url).then(()=>{ alert('链接已复制'); }); }
    // Device management
    let devices=[];
    function loadDevices(){ const saved=localStorage.getItem('devices'); if(saved) devices=JSON.parse(saved); renderDevices(); }
    function renderDevices(){ const grid=document.getElementById('device-grid'); grid.innerHTML=''; devices.forEach((d,idx)=>{ const div=document.createElement('div'); div.className='dev-card'; div.innerHTML=`<h4>${d.alias}</h4><div class="small">ID: ${d.id}</div><div class="small">Sub: ${d.sub}</div><div class="small">Pub: ${d.pub}</div><div class="actions"><button class="btn" onclick="useDevice(${idx})">使用</button><button class="btn secondary" onclick="removeDevice(${idx})">删除</button></div>`; grid.appendChild(div); }); }
    function useDevice(idx){ const d=devices[idx]; document.getElementById('inp-ws').value='wss://broker.emqx.io:8084/mqtt'; document.getElementById('inp-sub').value=d.sub; document.getElementById('inp-pub').value=d.pub; document.getElementById('inp-dev').value=d.id; showSection('dashboard'); connectModal(); }
    function removeDevice(idx){ devices.splice(idx,1); saveDevices(); renderDevices(); }
    function saveDevices(){ localStorage.setItem('devices', JSON.stringify(devices)); }
    function openAddDevice(){ document.getElementById('modal-device-mask').style.display='flex'; }
    function confirmAddDevice(){ const alias=document.getElementById('inp-alias').value.trim(); const id=document.getElementById('inp-deviceId').value.trim(); const sub=document.getElementById('inp-subTopic').value.trim(); const pub=document.getElementById('inp-pubTopic').value.trim(); if(!alias || !id || !sub || !pub){ alert('请填写完整信息'); return; } devices.push({ alias:alias, id:id, sub:sub, pub:pub }); saveDevices(); renderDevices(); closeDeviceModal(); }
  </script>
</body>
</html>