<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>雾境智培 - Web控制台</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: rgba(255, 255, 255, 0.92);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-top: 0;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f0f2f5;
      font-size: 12px;
    }
    .tag.ok { background: #eafbf0; color: #0a7b36; }
    .tag.bad { background: #fff1f0; color: #cf1322; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    .tile {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #eee;
    }
    .tile .k {
      font-size: 12px;
      color: #666;
    }
    .tile .v {
      font-size: 22px;
      font-weight: bold;
      margin-top: 6px;
    }

    .controls {
      margin-top: 18px;
      border-top: 1px solid #eee;
      padding-top: 14px;
    }
    .switch {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .switch input[type="checkbox"] {
      width: 46px;
      height: 24px;
    }

    .debug {
      margin-top: 18px;
      border-top: 1px solid #eee;
      padding-top: 14px;
    }
    pre {
      background: #0b1020;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 10px;
      overflow: auto;
      max-height: 320px;
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>雾境智培 - Web控制台</h1>

    <div class="row">
      <div>
        <span class="tag" id="connTag">MQTT 未连接</span>
        <span class="tag" id="devTag">deviceId: -</span>
      </div>
      <div>
        <span class="tag" id="stm32Tag">STM32: -</span>
        <span class="tag" id="diagTag">rxOk: - / crcErr: -</span>
      </div>
    </div>

    <div class="grid" id="metricsGrid">
      <div class="tile"><div class="k">温度</div><div class="v" id="tempValue">-</div></div>
      <div class="tile"><div class="k">湿度</div><div class="v" id="humValue">-</div></div>
      <div class="tile"><div class="k">光照</div><div class="v" id="luxValue">-</div></div>
      <div class="tile"><div class="k">EC</div><div class="v" id="ecValue">-</div></div>
      <div class="tile"><div class="k">pH</div><div class="v" id="phValue">-</div></div>
      <div class="tile"><div class="k">水量</div><div class="v" id="waterValue">-</div></div>
      <div class="tile"><div class="k">运行时间</div><div class="v" id="runtimeValue">-</div></div>
      <div class="tile"><div class="k">感应状态</div><div class="v" id="sensorValue">-</div></div>
      <div class="tile"><div class="k">喷雾</div><div class="v" id="mistValue">-</div></div>
      <div class="tile"><div class="k">雾化强度</div><div class="v" id="mistDutyValue">-</div></div>
      <div class="tile"><div class="k">风扇</div><div class="v" id="fanValue">-</div></div>
      <div class="tile"><div class="k">补光PWM</div><div class="v" id="pwmValue">-</div></div>
      <!-- 新增的水位与RSSI -->
      <div class="tile"><div class="k">水位(0/1)</div><div class="v" id="waterLevelStateValue">-</div></div>
      <div class="tile"><div class="k">液位RSSI</div><div class="v" id="lvRssiValue">-</div></div>
    </div>

    <div class="controls">
      <h3>控制</h3>
      <div class="row">
        <div class="switch">
          <label for="fanToggle">风扇开关</label>
          <input type="checkbox" id="fanToggle" />
        </div>
        <div class="switch">
          <label for="heaterToggle">加热开关</label>
          <input type="checkbox" id="heaterToggle" />
        </div>
      </div>
      <div class="hint">
        Web 控制仍使用 <code>home/control</code>（fan/heater）。如果需要网页端更多控制项，建议统一走 OneNET 或加一层后端鉴权。
      </div>
    </div>

    <div class="debug">
      <h3>调试 / 原始数据（自动合并多包）</h3>
      <pre id="rawPre">{}</pre>
    </div>
  </div>

  <script>
    // === MQTT 配置（与 ESP32 Web/MQTT 输出保持一致）
    var MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
    var TOPIC_DATA = 'home/data';
    var TOPIC_CONTROL = 'home/control';

    var state = {};

    function setTag(id, text, cls) {
      var el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
      el.className = 'tag' + (cls ? (' ' + cls) : '');
    }

    function setText(id, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.textContent = (text === undefined || text === null || text === '') ? '-' : String(text);
    }

    function fmtNum(v, suffix) {
      if (v === undefined || v === null || v === '') return '-';
      var n = Number(v);
      if (!isFinite(n)) return String(v);
      var s = n;
      return String(s) + (suffix || '');
    }

    function render() {
      // tags
      setTag('devTag', 'deviceId: ' + (state.deviceId || '-'));

      var stm32Online = (state.stm32Online === true || state.stm32Online === 1 || state.stm32Online === 'true');
      setTag('stm32Tag', 'STM32: ' + (stm32Online ? '在线' : '离线'), stm32Online ? 'ok' : 'bad');

      var rxOk = (state.rxOk !== undefined) ? state.rxOk : '-';
      var crcErr = (state.crcErr !== undefined) ? state.crcErr : '-';
      setTag('diagTag', 'rxOk: ' + rxOk + ' / crcErr: ' + crcErr);

      // metrics
      setText('tempValue', fmtNum(state.temp, ' ℃'));
      setText('humValue', fmtNum(state.hum, ' %RH'));
      setText('luxValue', fmtNum(state.lux, ' lx'));
      setText('ecValue', fmtNum(state.ec, ''));
      setText('phValue', fmtNum(state.ph, ''));
      setText('waterValue', fmtNum(state.water, ' L'));
      setText('runtimeValue', fmtNum(state.runtime, ' h'));
      setText('sensorValue', (state.sensorState === true || state.sensorState === 1) ? '感应到' : (state.sensorState === false || state.sensorState === 0 ? '未感应到' : '-'));
      setText('mistValue', (state.mistEnable === true || state.mistEnable === 1) ? '开启' : (state.mistEnable === false || state.mistEnable === 0 ? '关闭' : '-'));
      setText('mistDutyValue', fmtNum(state.mistDuty, ' %'));
      setText('fanValue', (state.fan === true || state.fan === 1) ? '开启' : (state.fan === false || state.fan === 0 ? '关闭' : (state.fanSpeed !== undefined ? fmtNum(state.fanSpeed, ' %') : '-')));
      setText('pwmValue', fmtNum(state.lightPWM, ' %'));
      // 新增水位与液位RSSI
      setText('waterLevelStateValue', fmtNum(state.waterLevelState, ''));
      setText('lvRssiValue', fmtNum(state.lvRssi, ''));

      // toggles
      var fanToggle = document.getElementById('fanToggle');
      var heaterToggle = document.getElementById('heaterToggle');
      if (fanToggle && (state.fan === true || state.fan === false)) fanToggle.checked = !!state.fan;
      if (heaterToggle && (state.heater === true || state.heater === false)) heaterToggle.checked = !!state.heater;

      // raw
      var rawPre = document.getElementById('rawPre');
      if (rawPre) {
        try {
          rawPre.textContent = JSON.stringify(state, null, 2);
        } catch (e) {
          rawPre.textContent = String(state);
        }
      }
    }

    console.log('Connecting to MQTT broker:', MQTT_BROKER);
    var client = mqtt.connect(MQTT_BROKER);

    client.on('connect', function () {
      console.log('Connected');
      setTag('connTag', 'MQTT 已连接', 'ok');
      client.subscribe(TOPIC_DATA, function (err) {
        if (err) console.error('Subscribe error:', err);
        else console.log('Subscribed:', TOPIC_DATA);
      });
    });

    client.on('reconnect', function () {
      setTag('connTag', 'MQTT 重连中...', '');
    });

    client.on('close', function () {
      setTag('connTag', 'MQTT 已断开', 'bad');
    });

    client.on('error', function (err) {
      console.error('MQTT error:', err);
      setTag('connTag', 'MQTT 错误', 'bad');
    });

    client.on('message', function (topic, message) {
      if (topic !== TOPIC_DATA) return;
      var txt = '';
      try { txt = message.toString(); } catch (e) { txt = '' + message; }
      try {
        var obj = JSON.parse(txt);
        if (obj && typeof obj === 'object') {
          // 合并多包：后来的字段覆盖旧字段
          for (var k in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, k)) {
              state[k] = obj[k];
            }
          }
        }
        render();
      } catch (e) {
        console.warn('Invalid JSON:', txt);
      }
    });

    // 控制
    document.getElementById('fanToggle').addEventListener('change', function () {
      var value = !!this.checked;
      var obj = { type: 'control', device: 'fan', state: value };
      if (state.deviceId) obj.deviceId = state.deviceId;
      var cmd = JSON.stringify(obj);
      client.publish(TOPIC_CONTROL, cmd);
      console.log('Sent fan control:', cmd);
    });

    document.getElementById('heaterToggle').addEventListener('change', function () {
      var value = !!this.checked;
      var obj = { type: 'control', device: 'heater', state: value };
      if (state.deviceId) obj.deviceId = state.deviceId;
      var cmd = JSON.stringify(obj);
      client.publish(TOPIC_CONTROL, cmd);
      console.log('Sent heater control:', cmd);
    });

    // init
    render();
  </script>
</body>
</html>